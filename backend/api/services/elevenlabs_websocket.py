"""
ElevenLabs WebSocket API für Echtzeit-Streaming
Ermöglicht bidirektionale Audio-Kommunikation (Conversational AI Agent)
"""
import asyncio
import websockets
import json
import base64
import logging
import os
from datetime import datetime
from pathlib import Path
from typing import Optional, Callable
from api.core.config import get_settings

logger = logging.getLogger(__name__)
settings = get_settings()

class ElevenLabsWebSocketClient:
    """
    WebSocket-Client für ElevenLabs Conversational AI
    """
    
    def __init__(self, voice_id: str = "21m00Tcm4TlvDq8ikWAM", agent_id: Optional[str] = None):
        self.voice_id = voice_id
        self.api_key = settings.ELEVENLABS_API_KEY
        self.websocket = None
        self.is_connected = False
        # Agent-ID aus ENV oder Parameter
        self.agent_id = agent_id or os.getenv("ELEVEN_CONVAI_AGENT_ID") or voice_id
        # WebSocket URL für Conversational AI (Agent-Modus)
        self.ws_url = f"wss://api.elevenlabs.io/v1/convai/conversation?agent_id={self.agent_id}"
        # Logging vorbereiten
        storage_root = Path(settings.STORAGE_LOCAL_PATH)
        self.log_dir = storage_root / "convai_logs"
        try:
            self.log_dir.mkdir(parents=True, exist_ok=True)
        except Exception:
            pass
        
    async def connect(self):
        """Verbindung zum ElevenLabs WebSocket herstellen"""
        try:
            # Optional: signierten URL holen (empfohlen für private Agents)
            signed_url = None
            try:
                if os.getenv("ELEVEN_CONVAI_SIGNED_URL", "1").lower() in ("1", "true", "yes"):
                    import httpx
                    async with httpx.AsyncClient(timeout=10.0) as client:
                        resp = await client.get(
                            f"https://api.elevenlabs.io/v1/convai/conversation/get-signed-url?agent_id={self.agent_id}",
                            headers={"xi-api-key": self.api_key}
                        )
                    if resp.status_code == 200:
                        data = resp.json()
                        signed_url = data.get("signed_url")
            except Exception as _e:
                signed_url = None

            # Für signierte URL keine Header; sonst Agent-ID-URL mit API-Key Header
            if signed_url:
                self.websocket = await websockets.connect(signed_url)
            else:
                headers = {"xi-api-key": self.api_key}
                self.websocket = await websockets.connect(self.ws_url, extra_headers=headers)
            
            self.is_connected = True
            logger.info("✅ ElevenLabs WebSocket verbunden")
            
            # Initiale Konfiguration senden
            await self.configure_session()
            
        except Exception as e:
            logger.error(f"❌ ElevenLabs WebSocket Verbindungsfehler: {e}")
            raise
    
    async def configure_session(self):
        """Session-Konfiguration senden (aktuelle Spec)."""
        init = {
            "type": "conversation_initiation_client_data",
            "conversation_config_override": {
                "agent": {
                    "prompt": {"prompt": "Du bist ein freundlicher deutscher Telefonassistent von VocalIQ. Antworte kurz, prägnant und hilfsbereit."},
                    "first_message": os.getenv("CONVAI_FIRST_MESSAGE", "Hallo! Ich bin Ihr Assistent. Wie kann ich helfen?"),
                    "language": "de"
                },
                "tts": {"voice_id": self.voice_id}
            },
            "custom_llm_extra_body": {"temperature": 0.4, "max_tokens": 80},
            "dynamic_variables": {}
        }
        await self.websocket.send(json.dumps(init))
        logger.info("📝 Conversation initiation gesendet")
        self._log_json("session_started", {"agent_id": self.agent_id, "voice_id": self.voice_id})
    
    async def send_audio(self, audio_data: bytes):
        """Benutzer-Audio als user_audio_chunk (Base64) senden."""
        if not self.is_connected:
            raise Exception("WebSocket nicht verbunden")
        
        audio_base64 = base64.b64encode(audio_data).decode('utf-8')
        await self.websocket.send(json.dumps({"user_audio_chunk": audio_base64}))
    
    async def receive_messages(self, on_audio: Optional[Callable] = None, 
                              on_transcript: Optional[Callable] = None):
        """Nachrichten vom WebSocket empfangen"""
        try:
            async for message in self.websocket:
                data = json.loads(message)
                
                if data.get("type") == "audio":
                    ev = data.get("audio_event") or {}
                    audio_base64 = ev.get("audio_base_64")
                    if audio_base64 and on_audio:
                        try:
                            audio_data = base64.b64decode(audio_base64)
                            await on_audio(audio_data)
                        except Exception:
                            pass
                
                elif data.get("type") == "user_transcript":
                    ev = data.get("user_transcription_event") or {}
                    text = ev.get("user_transcript")
                    is_final = ev.get("is_final", False)
                    self._log_json("transcript", {"text": text, "is_final": is_final})
                    if text and on_transcript:
                        await on_transcript(text, is_final)
                
                elif data.get("type") == "agent_response":
                    ev = data.get("agent_response_event") or {}
                    agent_text = ev.get("agent_response")
                    self._log_json("agent_response", {"text": agent_text})
                 
                elif data.get("type") == "interruption":
                    logger.info("🔄 Unterbrechung erkannt")
                    self._log_json("interruption", {})
                 
                elif data.get("type") == "ping":
                    # Pong mit event_id zurücksenden
                    ping_ev = data.get("ping_event") or {}
                    event_id = ping_ev.get("event_id")
                    msg = {"type": "pong"}
                    if event_id is not None:
                        msg["event_id"] = event_id
                    await self.websocket.send(json.dumps(msg))
                 
                elif data.get("type") == "error":
                    logger.error(f"❌ ElevenLabs Fehler: {data.get('message')}")
                    self._log_json("error", {"message": data.get("message")})
                    
        except websockets.exceptions.ConnectionClosed:
            logger.info("WebSocket Verbindung geschlossen")
            self.is_connected = False
            self._log_json("session_closed", {})
        except Exception as e:
            logger.error(f"Fehler beim Empfangen: {e}")
            self.is_connected = False
            self._log_json("receive_exception", {"error": str(e)})
    
    async def disconnect(self):
        """Verbindung trennen"""
        if self.websocket:
            await self.websocket.close()
            self.is_connected = False
            logger.info("🔌 ElevenLabs WebSocket getrennt")


class ConversationManager:
    """
    Verwaltet eine vollständige Konversation mit ElevenLabs
    """
    
    def __init__(self, voice_id: str = "21m00Tcm4TlvDq8ikWAM"):
        self.client = ElevenLabsWebSocketClient(voice_id)
        self.audio_queue = asyncio.Queue()
        self.transcript_queue = asyncio.Queue()
        
    async def start_conversation(self):
        """Konversation starten"""
        await self.client.connect()
        
        # Empfangs-Task starten
        asyncio.create_task(self._receive_loop())
        
    async def _receive_loop(self):
        """Empfangsschleife für Nachrichten"""
        await self.client.receive_messages(
            on_audio=self._handle_audio,
            on_transcript=self._handle_transcript
        )
    
    async def _handle_audio(self, audio_data: bytes):
        """Audio-Daten verarbeiten"""
        await self.audio_queue.put(audio_data)
    
    async def _handle_transcript(self, text: str, is_final: bool):
        """Transkript verarbeiten"""
        await self.transcript_queue.put({
            "text": text,
            "is_final": is_final
        })
    
    async def send_user_audio(self, audio_data: bytes):
        """Benutzer-Audio senden"""
        await self.client.send_audio(audio_data)
    
    async def get_ai_audio(self) -> Optional[bytes]:
        """KI-Audio aus Queue holen"""
        try:
            return await asyncio.wait_for(
                self.audio_queue.get(),
                timeout=0.1
            )
        except asyncio.TimeoutError:
            return None
    
    async def get_transcript(self) -> Optional[dict]:
        """Transkript aus Queue holen"""
        try:
            return await asyncio.wait_for(
                self.transcript_queue.get(),
                timeout=0.1
            )
        except asyncio.TimeoutError:
            return None
    
    async def end_conversation(self):
        """Konversation beenden"""
        await self.client.disconnect()


# Singleton-Instanz für globale Nutzung
conversation_manager: Optional[ConversationManager] = None

async def get_conversation_manager(voice_id: str = "21m00Tcm4TlvDq8ikWAM") -> ConversationManager:
    """Conversation Manager Instanz holen oder erstellen"""
    global conversation_manager
    
    if conversation_manager is None:
        conversation_manager = ConversationManager(voice_id)
        await conversation_manager.start_conversation()
    
    return conversation_manager



















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































"""
ElevenLabs WebSocket API für Echtzeit-Streaming
Ermöglicht bidirektionale Audio-Kommunikation (Conversational AI Agent)
"""
import asyncio
import websockets
import json
import base64
import logging
import os
from datetime import datetime
from pathlib import Path
from typing import Optional, Callable
from api.core.config import get_settings

logger = logging.getLogger(__name__)
settings = get_settings()

class ElevenLabsWebSocketClient:
    """
    WebSocket-Client für ElevenLabs Conversational AI
    """
    
    def __init__(self, voice_id: str = "21m00Tcm4TlvDq8ikWAM", agent_id: Optional[str] = None):
        self.voice_id = voice_id
        self.api_key = settings.ELEVENLABS_API_KEY
        self.websocket = None
        self.is_connected = False
        # Agent-ID aus ENV oder Parameter
        self.agent_id = agent_id or os.getenv("ELEVEN_CONVAI_AGENT_ID") or voice_id
        # WebSocket URL für Conversational AI (Agent-Modus)
        self.ws_url = f"wss://api.elevenlabs.io/v1/convai/conversation?agent_id={self.agent_id}"
        # Logging vorbereiten
        storage_root = Path(settings.STORAGE_LOCAL_PATH)
        self.log_dir = storage_root / "convai_logs"
        try:
            self.log_dir.mkdir(parents=True, exist_ok=True)
        except Exception:
            pass
        
    async def connect(self):
        """Verbindung zum ElevenLabs WebSocket herstellen"""
        try:
            headers = {
                "xi-api-key": self.api_key,
            }
            
            self.websocket = await websockets.connect(
                self.ws_url,
                extra_headers=headers
            )
            
            self.is_connected = True
            logger.info("✅ ElevenLabs WebSocket verbunden")
            
            # Initiale Konfiguration senden
            await self.configure_session()
            
        except Exception as e:
            logger.error(f"❌ ElevenLabs WebSocket Verbindungsfehler: {e}")
            raise
    
    async def configure_session(self):
        """Session-Konfiguration senden"""
        config = {
            "type": "conversation_initiation_metadata",
            "conversation_config": {
                "agent": {
                    "prompt": {
                        "prompt": """Du bist ein freundlicher KI-Assistent von VocalIQ.
                        Sprich Deutsch und antworte kurz und prägnant.
                        Sei hilfsbereit und professionell.""",
                    },
                    "language": "de",
                    "voice": {
                        "voice_id": self.voice_id,
                        "stability": 0.5,
                        "similarity_boost": 0.75,
                        "style": 0.0,
                        "use_speaker_boost": True
                    }
                },
                "asr": {
                    "quality": "high",
                    "provider": "deepgram"
                },
                "turn_detection": {
                    "type": "server_vad",
                    "threshold": 0.5,
                    "prefix_padding_ms": 300,
                    "silence_duration_ms": 500
                }
            }
        }
        
        await self.websocket.send(json.dumps(config))
        logger.info("📝 Session konfiguriert")
        self._log_json("session_started", {"agent_id": self.agent_id, "voice_id": self.voice_id})
    
    async def send_audio(self, audio_data: bytes):
        """Audio-Daten an ElevenLabs senden"""
        if not self.is_connected:
            raise Exception("WebSocket nicht verbunden")
        
        # Audio als Base64 codieren
        audio_base64 = base64.b64encode(audio_data).decode('utf-8')
        
        message = {
            "type": "audio",
            "audio": audio_base64
        }
        
        await self.websocket.send(json.dumps(message))
    
    async def receive_messages(self, on_audio: Optional[Callable] = None, 
                              on_transcript: Optional[Callable] = None):
        """Nachrichten vom WebSocket empfangen"""
        try:
            async for message in self.websocket:
                data = json.loads(message)
                
                if data["type"] == "audio":
                    # Audio-Response empfangen
                    audio_base64 = data.get("audio")
                    if audio_base64 and on_audio:
                        audio_data = base64.b64decode(audio_base64)
                        await on_audio(audio_data)
                
                elif data["type"] == "transcript":
                    # Transkript empfangen
                    text = data.get("text")
                    is_final = data.get("is_final", False)
                    self._log_json("transcript", {"text": text, "is_final": is_final})
                    if text and on_transcript:
                        await on_transcript(text, is_final)
                
                elif data["type"] == "interruption":
                    logger.info("🔄 Unterbrechung erkannt")
                    self._log_json("interruption", {})
                
                elif data["type"] == "ping":
                    # Pong zurücksenden
                    await self.websocket.send(json.dumps({"type": "pong"}))
                
                elif data["type"] == "error":
                    logger.error(f"❌ ElevenLabs Fehler: {data.get('message')}")
                    self._log_json("error", {"message": data.get("message")})
                    
        except websockets.exceptions.ConnectionClosed:
            logger.info("WebSocket Verbindung geschlossen")
            self.is_connected = False
            self._log_json("session_closed", {})
        except Exception as e:
            logger.error(f"Fehler beim Empfangen: {e}")
            self.is_connected = False
            self._log_json("receive_exception", {"error": str(e)})
    
    async def disconnect(self):
        """Verbindung trennen"""
        if self.websocket:
            await self.websocket.close()
            self.is_connected = False
            logger.info("🔌 ElevenLabs WebSocket getrennt")


class ConversationManager:
    """
    Verwaltet eine vollständige Konversation mit ElevenLabs
    """
    
    def __init__(self, voice_id: str = "21m00Tcm4TlvDq8ikWAM"):
        self.client = ElevenLabsWebSocketClient(voice_id)
        self.audio_queue = asyncio.Queue()
        self.transcript_queue = asyncio.Queue()
        
    async def start_conversation(self):
        """Konversation starten"""
        await self.client.connect()
        
        # Empfangs-Task starten
        asyncio.create_task(self._receive_loop())
        
    async def _receive_loop(self):
        """Empfangsschleife für Nachrichten"""
        await self.client.receive_messages(
            on_audio=self._handle_audio,
            on_transcript=self._handle_transcript
        )
    
    async def _handle_audio(self, audio_data: bytes):
        """Audio-Daten verarbeiten"""
        await self.audio_queue.put(audio_data)
    
    async def _handle_transcript(self, text: str, is_final: bool):
        """Transkript verarbeiten"""
        await self.transcript_queue.put({
            "text": text,
            "is_final": is_final
        })
    
    async def send_user_audio(self, audio_data: bytes):
        """Benutzer-Audio senden"""
        await self.client.send_audio(audio_data)
    
    async def get_ai_audio(self) -> Optional[bytes]:
        """KI-Audio aus Queue holen"""
        try:
            return await asyncio.wait_for(
                self.audio_queue.get(),
                timeout=0.1
            )
        except asyncio.TimeoutError:
            return None
    
    async def get_transcript(self) -> Optional[dict]:
        """Transkript aus Queue holen"""
        try:
            return await asyncio.wait_for(
                self.transcript_queue.get(),
                timeout=0.1
            )
        except asyncio.TimeoutError:
            return None
    
    async def end_conversation(self):
        """Konversation beenden"""
        await self.client.disconnect()


# Singleton-Instanz für globale Nutzung
conversation_manager: Optional[ConversationManager] = None

async def get_conversation_manager(voice_id: str = "21m00Tcm4TlvDq8ikWAM") -> ConversationManager:
    """Conversation Manager Instanz holen oder erstellen"""
    global conversation_manager
    
    if conversation_manager is None:
        conversation_manager = ConversationManager(voice_id)
        await conversation_manager.start_conversation()
    
    return conversation_manager













































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































